<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Table</title>
    <link rel="stylesheet" href="./css/index.css">
    <style>
        table,
        form {
            margin-top: 4rem;
            width: 600px;
            margin-inline: auto;

        }

        thead {
            background: black;
            color: gainsboro
        }

        th,
        td {
            padding: 5px 10px;
            text-align: left;
        }

        form {
            background-color: rgba(255, 255, 255, 0.37);
            padding: 1rem;
            border-radius: 10px;
        }

        form button {
            width: 50%;
            padding: 10px;
            background-color: black;
            color: white;
            font-weight: bold;
            margin-top: 2rem;
            margin-inline: auto;
        }

        label,
        input,
        button {
            display: block;
            font-family: inherit;

        }

        input {
            width: 100%;
            padding: 2px 10px;
            border-radius: 5px;
            min-height: 40px;
            outline: none;
            border: none;
            margin-top: 2px;
        }

        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .action {
            padding: 5px;
            font-size: 10px;
            background-color: black;
            color: gainsboro;
            border-radius: 3px;
            font-weight: 600;
        }

        .action:hover {
            background-color: gainsboro;
            color: black;
        }
    </style>
</head>

<body>
    <nav>
        <ul>
            <li>
                <a href="index.html">Home</a>
            </li>
            <li>
                <a href="student.html">Student</a>
            </li>
        </ul>
    </nav>


    <div id="loader">
        <svg xmlns="http://www.w3.org/2000/svg" style="margin:auto; background:transparent; display:block;" width="50px"
            height="50px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
            <circle cx="50" cy="50" r="32" stroke-width="8" stroke="#3498db"
                stroke-dasharray="50.26548245743669 50.26548245743669" fill="none" stroke-linecap="round">
                <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
                    keyTimes="0;1" values="0 50 50;360 50 50"></animateTransform>
            </circle>
        </svg>

    </div>

    <table>
        <thead>
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>DOB</th>
                <th>Program</th>
                <th>Year</th>
                <th></th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>

    <!-- Add Student Form -->

    <form>
        <div class="form-container">
            <div class="item">
                <label for="fName">
                    First Name
                </label>
                <input name="fName" id="fName" type="text">
            </div>
            <div class="item">
                <label for="lName">
                    Last Name
                </label>
                <input name="lName" id="lName" type="text">
            </div>
            <div class="item">
                <label for="dob">
                    Date of Birth
                </label>
                <input name="dob" id="dob" type="date">
            </div>
            <div class="item">
                <label for="program">
                    Program
                </label>
                <input name="program" id="program" type="text">
            </div>
            <div class="item">
                <label for="country">
                    Country
                </label>
                <input name="country" id="country" type="text">
            </div>
            <div class="item">
                <label for="year">
                    Year
                </label>
                <input name="year" id="year" type="number">
            </div>
        </div>
        <button>Submit</button>
    </form>
    <script>
        const tb = document.querySelector('tbody')
        const form = document.querySelector('form')
        const loader = document.getElementById('loader')

        function createEl(arg) {
            return document.createElement(arg)
        }

        function fetchStudents() {
            const xhr = new XMLHttpRequest();
            const url = "https://dbms-dxyg.onrender.com/students";
            let data = [];

            xhr.open("GET", url, true);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 3) {
                    console.log("loading");
                    loader.style.display = "none";
                }

                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            loader.style.display = "block";
                            data = JSON.parse(xhr.responseText);

                            data.forEach(x => {
                                const newDate = new Date(x.dob);
                                const date = new Intl.DateTimeFormat('en-US', {
                                    year: 'numeric',
                                    month: "numeric",
                                    day: "numeric"
                                }).format(newDate);

                                const row = createEl('tr');
                                const fName = createEl('td');
                                const lName = createEl('td');
                                const dob = createEl('td');
                                const program = createEl('td');
                                const year = createEl('td');
                                const action = createEl('td');

                                fName.innerText = x.fName;
                                lName.innerText = x.lName;
                                dob.innerText = date;
                                program.innerText = x.program;
                                year.innerText = x.year;
                                action.innerHTML = `<a class="action" href="student.html?id=${x._id}">View more</a>`;

                                row.appendChild(fName);
                                row.appendChild(lName);
                                row.appendChild(dob);
                                row.appendChild(program);
                                row.appendChild(year);
                                row.appendChild(action);

                                tb.appendChild(row);
                            });
                        } catch (err) {
                            console.error("Error parsing JSON:", err);
                        }
                    } else if (xhr.status === 304) {
                        console.log(xhr.status);
                        loader.style.display = "none";
                    } else {
                        console.error("Error:", xhr.status, xhr.statusText);
                    }
                }

           
            };

            xhr.onerror = function () {
                console.error("Request failed.");
            };

            xhr.send();
        }

        fetchStudents()

        form.addEventListener('submit', async e => {
            e.preventDefault()

            try {
                const formData = new FormData(e.target)
                const data = JSON.stringify(Object.fromEntries(formData))
                console.log(data)
                const res = await fetch("https://dbms-dxyg.onrender.com/students", {
                    method: "POST",
                    headers: {
                        'Content-Type': "application/json"
                    },
                    body: data
                })

                const dt = await res.json()
                window.location.reload()
            } catch (err) {
                console.log(err)
            }
        })


    </script>
</body>

</html>